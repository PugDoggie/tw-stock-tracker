# 库存清单 (Portfolio) 功能说明

## 功能概述

库存清单功能允许用户管理自己的持股记录，并获得基于持有成本的AI推荐。

## 主要功能

### 1. 持股管理

- **添加持股**: 点击"+ 添加"按钮，输入股票代码/名称、成本价格和持有数量
- **查看持股**: 表格显示所有持股的代码、名称、成本价、现价、数量、损益%
- **删除持股**: 点击"删除"按钮移除持股记录
- **数据持久化**: 所有持股记录保存到浏览器localStorage

### 2. 组合统计

显示实时的组合统计数据：

- **成本總額**: 所有持股的总购入成本
- **目前市值**: 按现价计算的总市值
- **損益金額**: 总盈亏（NT$）
- **損益率**: 总回报率（%）

### 3. AI驱动的持仓建议

#### AI建议规则逻辑：

| 条件                              | 建议         | 说明                     |
| --------------------------------- | ------------ | ------------------------ |
| 已获利 > 15% 且 RSI > 70          | **売出**     | 高位超买，建议减仓获利   |
| 下跌 5-10% 且 RSI < 30 + 强买信号 | **加碼**     | 超卖反弹机会，可平均成本 |
| 已获利 5-15% 且 AI强买            | **加碼**     | 趋势向上，扩大获利潜力   |
| 接近目标价 (< 5%)                 | **獲利出場** | 获利了结，卖出部分头寸   |
| 接近止损价 (< 3%)                 | **止損**     | 风险加剧，立即止损       |
| 其他情况                          | **持有**     | 继续持有，监控技术面     |

#### 建议信息包括：

- **Action**: 行动建议（売出/加碼/止損/獲利出場/持有）
- **Confidence**: 信心度 (40-95%)
- **Reasoning**: 详细理由
- **Target Price**: 目标价
- **Stop Loss**: 止损价

### 4. 损益计算

每个持股显示：

- 成本价 (NT$)
- 现价 (NT$)
- 损益百分比 (%)
- 损益金额 (NT$)

## 技术架构

### 核心文件

1. **[src/context/PortfolioContext.jsx](src/context/PortfolioContext.jsx)**
   - 管理持仓状态
   - 提供CRUD操作
   - 计算组合统计

2. **[src/services/aiAnalysis.js](src/services/aiAnalysis.js)**
   - `getPortfolioAISuggestion()` 函数
   - 基于持有成本的AI分析
   - 集成技术指标评估

3. **[src/components/PortfolioPanel.jsx](src/components/PortfolioPanel.jsx)**
   - 主持仓展示组件
   - 表格显示和统计
   - AI建议可视化

4. **[src/components/AddPositionModal.jsx](src/components/AddPositionModal.jsx)**
   - 添加/编辑持股对话框
   - 股票搜索功能
   - 输入验证

5. **[src/components/Dashboard.jsx](src/components/Dashboard.jsx)**
   - 集成PortfolioPanel
   - 传递实时股票数据

6. **[src/App.jsx](src/App.jsx)**
   - 包裹PortfolioProvider

## 使用流程

### 第一次使用

1. 打开应用首页
2. 在Dashboard中找到"庫存組合"区块
3. 点击"+ 添加"按钮
4. 搜索并选择要添加的股票
5. 输入成本价和持有数量
6. 点击"確認添加"

### 日常使用

1. 组合自动从liveStocks获取最新价格
2. 损益数据实时更新
3. AI建议根据技术指标动态生成
4. 可点击表格中的"建议详情"了解详细分析

### 管理持仓

- 添加新持股：点击"+ 添加"
- 删除持股：点击"刪除"按钮
- 更新持股：删除后重新添加（后续可扩展为直接编辑）

## 数据存储

持仓数据存储在浏览器 `localStorage` 的 `tw-stock-portfolio` 键中，格式：

```json
[
  {
    "id": "pos_1234567890",
    "stockId": "2330",
    "name": "台積電",
    "costPrice": 500.5,
    "quantity": 10,
    "addedAt": "2026-01-23T10:00:00.000Z",
    "updatedAt": "2026-01-23T10:00:00.000Z"
  }
]
```

## AI建议可信度评估

### 可信度来源

1. **技术指标一致性** (20%)
   - RSI、MACD、MA、Bollinger Band的信号对齐

2. **市场环境** (30%)
   - 大盘与股票相关性
   - 权重股权重影响

3. **历史准确率** (30%)
   - 基于指标的历史胜率计算

4. **特定持仓因素** (20%)
   - 距离目标价/止损价远近程度
   - 累计收益或亏损幅度

### 建议胜率

- **高信心** (> 80%): 建议行动明确，多重指标同向
- **中信心** (60-80%): 趋势清晰但有部分分歧信号
- **低信心** (< 60%): 信号混合或震荡市

## 未来扩展方向

1. **高级功能**
   - 支持批量导入持股
   - 成本均价计算器
   - 分批加码/减仓计划
   - 风险管理工具

2. **通知与警报**
   - 价格达到目标/止损时通知
   - 定期AI建议推送
   - 异常波动警报

3. **分析增强**
   - 历史回溯分析
   - 多时间周期建议
   - 风险评分

4. **集成功能**
   - 与证券交易API集成
   - 实时委托单支持
   - 交易历史记录

## 常见问题

**Q: 如何编辑已添加的持股?**
A: 当前版本需要先删除后重新添加。后续版本会支持直接编辑。

**Q: AI建议为什么有时显示"loading..."?**
A: 系统正在获取实时数据和计算AI分析。请稍等几秒。

**Q: 持仓数据会丢失吗?**
A: 数据保存在浏览器localStorage中。清除浏览器数据或切换浏览器会丢失。建议定期备份。

**Q: 目标价和止损价如何确定?**
A: 由AI基于技术指标和市场条件动态计算，会随着价格和指标变化而调整。
